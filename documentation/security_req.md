#  Документ требований по безопасности приложения

**Версия:** 1.0  
**Дата:** 09.02.2026  

---

## Цель документа

Обеспечить надежную защиту приложения на всех уровнях: аутентификация, авторизация, бизнес-логика, платежи, антифрод, API, клиентская защита.  

Документ содержит:
- **Требования к реализации** для команды разработки  
- **Чек-листы** для QA и AppSec  
- Подробные пояснения и рекомендации по каждому пункту  

Все пункты обязательны к реализации перед продакшеном.

---

## 1. Аутентификация (Authentication)

**Цель:** Обеспечить безопасный вход пользователей и защиту ресурсов от несанкционированного доступа.

### Требования:

- Все защищённые эндпоинты (`protected endpoints`) требуют авторизации.  
- **Access token**: короткий TTL (например, 15 минут), нельзя использовать после refresh.  
- **Refresh token**:
  - Ротируется при каждом использовании
  - Инвалидируется при logout
- Logout должен реально отзывать все активные сессии пользователя.  
- Не должно быть endpoint’ов без аутентификации «по ошибке».  

### Проверки для QA/DevSecOps:

- Использование просроченного access token → доступ запрещён  
- Повторный refresh → отклоняется  
- Подмена токена → отклоняется и логируется  

### Рекомендации:

- Использовать JWT с версией токена (`token_version`) для быстрой инвалидизации  
- Проверка токена через middleware на всех защищённых маршрутах  
- Логи всех failed login attempts + refresh token usage  

---

## 2. Авторизация (Authorization)

**Цель:** Контроль доступа к ресурсам на уровне ролей и объектов.

### RBAC (Role-Based Access Control):

- Worker не может выполнять действия Business  
- Business не может выполнять действия Admin  
- Admin actions защищены дополнительной проверкой  

### Object-Level Access Control:

- Нельзя получить чужую смену по ID  
- Нельзя check-in чужой смены  
- Нельзя посмотреть чужие выплаты  
- Нельзя изменить чужой профиль  

**Критическая уязвимость:** Broken Object Level Authorization (BOLA) – самые частые критические баги.  

### Рекомендации:

- Проверять ownership (`user_id == current_user.id`) на всех критичных ресурсах  
- Использовать middleware для повторяющихся проверок  
- Логи всех попыток несанкционированного доступа  

---

## 3. Business Logic

### Смены (Shifts):

- Check-in только после принятия смены  
- Check-out только после check-in  
- Нельзя завершить смену раньше времени  
- Нельзя изменить время смены после старта  
- Нельзя выполнить смену дважды  
- Одновременный check-in с разных устройств запрещён  

### Финансовая логика:

- Выплата возможна только после завершения смены  
- Выплата невозможна без холда  
- Нельзя изменить сумму выплаты с клиента  
- Комиссия рассчитывается сервером, клиент не участвует  

**Рекомендации:**

- Использовать уникальные идентификаторы сессий для check-in/check-out  
- Проверять состояние смены перед финансовыми операциями  
- Логировать все критические действия  

---

## 4. Платежи

### Webhooks:

- Проверять подпись PSP (Payment Service Provider)  
- Реализовать idempotency ключи → повторный webhook не должен дублировать выплату  
- Неверный webhook → reject + логирование  

### Платёжный поток:

- Hold → Capture → Payout соблюдается строго  
- Нельзя payout без capture  
- Ошибки PSP корректно обрабатываются и логируются  

**Рекомендации:**

- Все действия с платежами проходить через backend, клиент не влияет на сумму или статус  
- Логи всех платежей + correlation ID для восстановления инцидента  

---

## 5. Rate Limiting & Abuse

### Эндпоинты с лимитами:

| Эндпоинт             | Ограничение по частоте | Примечание |
|----------------------|----------------------|------------|
| OTP / Login          | 5 попыток/мин       | Защита от brute-force |
| Apply to job         | 10 попыток/мин      | Защита от спама |
| Check-in / Check-out | 10 попыток/мин      | Защита от abuse |
| Payments endpoints   | 5 попыток/мин       | Защита от повторных выплат |

**Дополнительно:**

- Блокировка при множественных неудачных попытках  
- Защита от SMS-bombing  
- Логирование всех rate-limit событий  

---

## 6. Anti-Fraud (MVP)

### Геолокация:

- Check-in только в радиусе геозоны  
- Резкие скачки координат детектируются  
- Эмуляция GPS не обходится  

### Поведение:

- Массовые отмены фиксируются  
- Мультиаккаунты флагируются  
- Подозрительные действия логируются и отправляются на review  

**Рекомендации:**

- Сохранять историю координат для анализа аномалий  
- Использовать флаги подозрительных действий для дальнейшего расследования  

---

## 7. Input Validation

- Все входные данные валидируются (тип, длина, формат)  
- Нельзя передавать лишние поля (`extra fields`)  
- Нельзя передавать отрицательные значения там, где это запрещено  
- Enum проверяются строго  

**Защита от уязвимостей:**

- SQL injection закрыт через ORM / parameterized queries  
- Mass assignment закрыт через whitelist полей  
- Unsafe deserialization отсутствует  

---

## 8. API Security

- Ограничение HTTP методов (GET ≠ POST ≠ PUT ≠ DELETE)  
- Админ-эндпоинты доступны только для соответствующих ролей  
- Версионирование API (v1, v2…)  
- Нет debug endpoint’ов в production  

---

## 9. Mobile / Client Security (Flutter)

- В клиенте **нет секретов** (API keys, private tokens)  
- Критическая логика выполняется только на backend:  
  - сумма выплат  
  - статус смены  
- SSL pinning рекомендуется для повышения безопасности  

---

## 10. Логи и аудит

- Логируются:  
  - Все события аутентификации  
  - Check-in / Check-out  
  - Все платежи  
  - Все admin действия  

**Проверки и рекомендации:**

- Логи нельзя редактировать вручную  
- Наличие correlation ID для отслеживания инцидентов  
- Логи должны позволять полностью восстановить событие  

---

## 11. Админ-панель

- Доступ только пользователям с нужной ролью  
- Нет массовых destructive actions без подтверждения  
- Все действия логируются  
- Нельзя изменять финансы без следа  

---

## 12. Secrets & Config

- Нет секретов в коде (env variables только)  
- Debug = False в production  
- Нет открытых admin endpoints  

---

## 13. Автоматизированные проверки

### SAST (Static Application Security Testing):

- Bandit  
- Semgrep  

### DAST (Dynamic Application Security Testing):

- OWASP ZAP (basic scan)  

---

## 14. Incident Readiness

- Возможность заблокировать пользователя  
- Возможность заморозить выплаты  
- Возможность вручную закрыть спор  
- Наличие контакта поддержки  

---

## 15. Финальный Go/No-Go чек

Приложение **НЕ ГОТОВО**, если:

- Можно получить деньги без смены  
- Можно получить доступ к чужим данным  
- Можно повторить платёж  
- Нельзя восстановить спор  

---

**Примечание:** Этот документ является обязательным к реализации. Каждый пункт должен быть подтверждён тестами и аудитом AppSec.
